#!/usr/bin/env python3

from argparse import ArgumentParser
from debian.deb822 import Packages
from collections import ChainMap
import lzma
import json
import sqlite3

parser = ArgumentParser(prog="debian-packages")
parser.add_argument("inputs", nargs="*")
parser.add_argument("--output", required=True)
args = parser.parse_args()

con = sqlite3.connect(args.output)
cur = con.cursor()
cur.execute("CREATE TABLE files(filename TEXT PRIMARY KEY, sha256 TEXT)")

for file in args.inputs:
    with lzma.open(file) as f:
        data = [
            (package["Filename"], package["SHA256"])
            for package in Packages.iter_paragraphs(f, use_apt_pkg=False)
        ]
        cur.executemany(f"INSERT OR IGNORE INTO files VALUES (?, ?)", data)
        con.commit()

con.close()
